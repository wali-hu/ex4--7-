# Lightning Network Payment Channel Implementation

**Student Name**: [Your Name]  
**Student ID**: [Your ID]

## Exercise Description

This project implements a bidirectional payment channel system similar to the Lightning Network. The implementation includes:

- Smart contract for secure fund locking and channel management
- Python nodes for off-chain state management and communication
- Appeal mechanism to prevent fraud and old state attacks
- Secure fund settlement after channel closure

## Setup Instructions

### Prerequisites
- Node.js and npm
- Python 3.12+
- Git

### Installation

1. **Clone and navigate to project**:
   ```bash
   cd /path/to/ex4--7-
   ```

2. **Install Hardhat dependencies**:
   ```bash
   npm install
   ```

3. **Create Python virtual environment**:
   ```bash
   python3 -m venv venv
   source venv/bin/activate
   ```

4. **Install Python dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

### Running the Project

1. **Start Hardhat local blockchain**:
   ```bash
   npx hardhat node
   ```

2. **In another terminal, run tests**:
   ```bash
   source venv/bin/activate
   python -m pytest
   ```

3. **Test web3 connectivity**:
   ```bash
   source venv/bin/activate
   python test_web3_connection.py
   ```

## Contract Behavior Summary

The Channel.sol contract implements:
- **Fund Locking**: Both parties deposit funds into the contract
- **State Management**: Tracks channel states with serial numbers
- **Channel Closure**: Either party can close with latest signed state
- **Appeal Window**: Time period for challenging fraudulent closures
- **Final Settlement**: Secure fund distribution after appeal period

## Project Structure

```
├── contracts/          # Solidity smart contracts
├── client/            # Python node implementation
├── tests/             # Test files
├── hardhat.config.js  # Hardhat configuration
├── requirements.txt   # Python dependencies
└── README             # This file
```

## Milestone 1 Status: COMPLETED

- [x] Hardhat project initialized and configured
- [x] Local blockchain node running successfully
- [x] Python virtual environment setup
- [x] web3.py connectivity verified
- [x] All dependencies installed and tested

## Milestone 2 Status: COMPLETED

### Part 1: Channel State Storage + Constructor
- [x] Constructor implemented with participant addresses
- [x] Deposit amounts stored correctly
- [x] Timeout/appeal period configured
- [x] Contract compiles without errors
- [x] Deployment works from Python
- [x] State variables readable via getters

### Part 2: Channel Closing Logic
- [x] `oneSidedClose()` function implemented
- [x] Signature validation working
- [x] State recording functional
- [x] Appeal timer triggered correctly
- [x] Events emitted (ChannelClosed)

### Part 3: Appeal/Challenge Logic
- [x] `appealClosure()` function implemented
- [x] Signature validation for appeals
- [x] Serial number comparison working
- [x] Newer state overrides older state
- [x] Invalid/lower states rejected
- [x] Events emitted (AppealMade)

### Part 4: Final Settlement Logic
- [x] `finalize()` implemented via `withdrawFunds()`
- [x] Ether transferred correctly to both parties
- [x] Re-entry protection working
- [x] One-time execution enforced
- [x] All unit tests passing

### Testing
Run Milestone 2 verification:
```bash
source venv/bin/activate
python test_milestone2.py
```

Expected output shows:
- Contract deployment with correct state
- Channel closure with signed state
- Appeal mechanism overriding old state
- Final settlement distributing funds correctly
- Re-entry protection preventing double withdrawal


## Milestone 3 Status: COMPLETED

### Part 1: Node Class Structure
- [x] `LightningNode` class implemented
- [x] Attributes: address, private_key, channel references
- [x] Signer helpers implemented
- [x] Node objects initialize correctly
- [x] Can sign messages
- [x] All initialization tests pass

### Part 2: State Update Messaging & Channel Closing
- [x] `send()` method implemented for state updates
- [x] Local state maintained correctly
- [x] State signing working
- [x] Network messaging via `Message` enum
- [x] Sender signs correctly
- [x] Receiver validates correctly
- [x] Updates stored properly
- [x] `close_channel()` implemented
- [x] Blockchain call to `oneSidedClose()` working
- [x] State + signature submitted correctly
- [x] Timeout logic triggered
- [x] Local node marked "closing"

### Part 3: Appeal Handler
- [x] `appeal_closed_chan()` implemented
- [x] Detects invalid closure from blockchain
- [x] Compares serial numbers correctly
- [x] Submits newer state via appeal function
- [x] Correct ordering ensured
- [x] Newer state overrides old
- [x] Tests confirm malicious node cannot steal funds

### Testing
Run Milestone 3 verification:
```bash
source venv/bin/activate
python -m pytest tests/test_basic_scenarios.py -v
```

Expected output shows:
- Channel establishment and immediate closure
- Money transfers off-chain (no blockchain transactions)
- Unilateral channel closure by either party
- Appeal mechanism preventing fraud
- Correct fund distribution after settlement
- Protection against double-closure attempts

All 7 basic scenario tests passing
